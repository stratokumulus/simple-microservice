apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  namespace: simple
  name: micro-rollout
  labels:
    app: micro
    strategy: canary
spec:
  replicas: 5

  # Rollout strategy: Canary with progressive traffic shifting
  strategy:
    canary:
      # Canary service (optional) - points to canary pods for testing
      # If not specified, both stable and canary pods are behind the same service
      # canaryService: micro-svc-canary

      # Stable service - points to stable version
      stableService: micro-svc

      # Traffic routing using native Kubernetes (pod count-based)
      # For advanced traffic management, use Istio/SMI/Traefik
      trafficRouting:
        # Using native Kubernetes - traffic split based on pod ratios
        # For more precise control, use service mesh
        managedRoutes: []

      # Define the steps for progressive canary rollout
      steps:
        # Step 1: Deploy canary with 20% traffic
        - setWeight: 20
        - pause:
            duration: 30s # Wait 30 seconds before proceeding

        # Step 2: If analysis passes, increase to 40%
        - setWeight: 40
        - pause:
            duration: 30s

        # Step 3: Run analysis before proceeding to majority traffic
        - setWeight: 60
        - pause:
            duration: 30s
        - analysis:
            templates:
              - templateName: micro-success-rate
            args:
              - name: service-name
                value: micro-svc

        # Step 4: Increase to 80% after successful analysis
        - setWeight: 80
        - pause:
            duration: 30s

      # Step 5: Full rollout (100%)
      # If analysis passes and no manual abort, promote to 100%

      # Maximum time for a canary rollout before automatic rollback
      maxSurgeWeight: 20

      # Maximum percentage of pods that can be unavailable during update
      maxUnavailable: 1

  # Keep history for rollback
  revisionHistoryLimit: 3

  selector:
    matchLabels:
      app: micro

  template:
    metadata:
      namespace: simple
      labels:
        app: micro
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9876"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        - name: micro
          image: stratokumulus/simple-microservice:latest
          imagePullPolicy: Always

          ports:
            - containerPort: 9876
              name: http
              protocol: TCP

          env:
            - name: DB_HOSTNAME
              valueFrom:
                simple-mapMapKeyRef:
                  name: simple-map
                  key: DB_HOSTNAME
            - name: DB_PORT
              valueFrom:
                simple-mapMapKeyRef:
                  name: simple-map
                  key: DB_PORT
            - name: DB_PASSWD
              valueFrom:
                secretKeyRef:
                  name: micro-secret
                  key: DB_PASSWD
            - name: APP_VERSION
              value: "v1.0.0"

          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi

          livenessProbe:
            httpGet:
              path: /metrics
              port: 9876
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /metrics
              port: 9876
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3
